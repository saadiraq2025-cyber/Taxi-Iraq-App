<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;background:#f5f5f5;}
#map{height:80vh;}
#panel{background:#fff;text-align:center;padding:10px;box-shadow:0 -2px 5px rgba(0,0,0,0.2);}
h3{color:#2e7d32;margin:5px 0;}
button{background:#fdd835;border:none;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer;margin:5px;}
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h3>ğŸš– Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
  <div id="rideInfo">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø­Ù„Ø§Øª...</div>
  <button id="endRide" disabled>ğŸš— Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<script>
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map').setView([33.3152,44.3661],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let driverMarker=null;
navigator.geolocation.getCurrentPosition(pos=>{
  const coords=[pos.coords.latitude,pos.coords.longitude];
  driverMarker=L.marker(coords).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
  map.setView(coords,15);
});

const rideInfo=document.getElementById("rideInfo");
const endBtn=document.getElementById("endRide");
let routeControl=null;
let beepInterval=null;
let driverStatus="available"; // Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù…ØªØ§Ø­/Ù…Ø´ØºÙˆÙ„)
let activeRideId=null;

// ğŸ”Š ØµÙˆØª Ù…ØªÙ‚Ø·Ø¹
function startBeep(){
  stopBeep();
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  beepInterval=setInterval(()=>{
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.type="sine";osc.frequency.value=800;
    osc.connect(gain);gain.connect(ctx.destination);
    osc.start();
    setTimeout(()=>osc.stop(),300);
  },2000);
  setTimeout(stopBeep,15000);
}
function stopBeep(){
  if(beepInterval){clearInterval(beepInterval);beepInterval=null;}
}

// ğŸŸ¢ ÙˆØ¸ÙŠÙØ© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª
function watchForRides(){
  firebase.database().ref("rides").on("child_added",snap=>{
    const ride=snap.val();
    const id=snap.key;

    // Ù„Ø§ ÙŠØ³ØªÙ‚Ø¨Ù„ Ø¥Ø°Ø§ Ù…Ø´ØºÙˆÙ„
    if(driverStatus==="busy") return;

    if(ride.status==="Ø¬Ø¯ÙŠØ¯Ø©"){
      startBeep();
      rideInfo.innerHTML=`
        ğŸš– <b>Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</b><br>
        Ù…Ù† (${ride.start[0].toFixed(4)}, ${ride.start[1].toFixed(4)})<br>
        Ø¥Ù„Ù‰ (${ride.end[0].toFixed(4)}, ${ride.end[1].toFixed(4)})<br>
        Ø§Ù„Ù…Ø³Ø§ÙØ©: ${ride.distance} ÙƒÙ…<br>
        Ø§Ù„Ø£Ø¬Ø±Ø©: ${ride.fare} Ø¯.Ø¹<br><br>
        <button id="acceptRide">âœ… Ù‚Ø¨ÙˆÙ„</button>
        <button id="rejectRide">âŒ Ø±ÙØ¶</button>
      `;

      // âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
      document.getElementById("acceptRide").onclick=()=>{
        stopBeep();
        driverStatus="busy"; // ÙŠØµØ¨Ø­ Ù…Ø´ØºÙˆÙ„
        activeRideId=id;

        firebase.database().ref("rides/"+id).update({
          status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©",
          notification:"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±"
        });

        rideInfo.innerHTML=`
          âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©<br>
          Ø§Ù„Ø±Ø§ÙƒØ¨: ${ride.riderPhone}<br>
          Ø§Ù„Ù…Ø³Ø§ÙØ©: ${ride.distance} ÙƒÙ…<br>
          Ø§Ù„Ø£Ø¬Ø±Ø©: ${ride.fare} Ø¯.Ø¹
        `;
        endBtn.disabled=false;

        // ğŸ—ºï¸ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ø¨Ø± Ø§Ù„Ø·Ø±Ù‚
        if(routeControl){map.removeControl(routeControl);}
        navigator.geolocation.getCurrentPosition(pos=>{
          const driverPos=[pos.coords.latitude,pos.coords.longitude];
          routeControl=L.Routing.control({
            waypoints:[
              L.latLng(driverPos[0],driverPos[1]),
              L.latLng(ride.end[0],ride.end[1])
            ],
            router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
            lineOptions:{styles:[{color:'blue',opacity:0.8,weight:5}]},
            addWaypoints:false,
            fitSelectedRoutes:true,
            show:false
          }).addTo(map);
        });
      };

      // âŒ Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©
      document.getElementById("rejectRide").onclick=()=>{
        stopBeep();
        firebase.database().ref("rides/"+id).update({
          status:"Ù…Ø±ÙÙˆØ¶Ø©",
          notification:"âŒ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©"
        });
        rideInfo.innerHTML="ğŸš• ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø© â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.";
      };
    }
  });

  // ğŸ”” Ø¥Ø°Ø§ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±
  firebase.database().ref("rides").on("child_changed", snapshot => {
    const updated = snapshot.val();
    if (updated.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && driverStatus==="available") {
      stopBeep();
      rideInfo.innerHTML = "ğŸš• ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø± â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©...";
      if (routeControl) { map.removeControl(routeControl); }
      endBtn.disabled = true;
    }
  });
}

watchForRides(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©

// ğŸš— Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
endBtn.onclick=()=>{
  if(!activeRideId) return;
  stopBeep();
  firebase.database().ref("rides/"+activeRideId).update({
    status:"Ù…Ù†ØªÙ‡ÙŠØ©",
    notification:"ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©"
  });
  if(routeControl){map.removeControl(routeControl);}
  endBtn.disabled=true;
  rideInfo.innerHTML="ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯...";
  driverStatus="available"; // ÙŠØ¹ÙˆØ¯ Ù…ØªØ§Ø­
  activeRideId=null;
};
</script>
</body>
</html>
